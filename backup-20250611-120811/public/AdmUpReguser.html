<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Usuarios - MAWI Super Admin</title>
    <link rel="stylesheet" href="css/admin-dashboard-stats.css">
    <link rel="stylesheet" href="css/sidebar-styles.css">
</head>
<body data-page="gestion-usuarios">
    <div class="admin-app-container">
        <!-- Header -->
        <header class="admin-header">
            <div class="admin-logo">
                <div class="admin-logo-icon">M</div>
                <h1>MAWI Super Admin</h1>
            </div>
            <div class="admin-user-menu">
                <div class="admin-user-info">
                    <div class="admin-avatar" id="userAvatar">SA</div>
                    <div>
                        <div class="admin-username" id="userName">Super Admin</div>
                        <div class="admin-user-role" id="userRole">Sistema</div>
                    </div>
                </div>
                <button class="admin-btn admin-btn-secondary" onclick="logout()">
                    <span>üö™</span> Cerrar Sesi√≥n
                </button>
            </div>
        </header>

        <!-- Sidebar Toggle -->
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Abrir/cerrar men√∫ lateral">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9,18 15,12 9,6"></polyline>
            </svg>
        </button>

        <div class="admin-content-wrapper">
            <!-- Sidebar Container -->
            <div id="sidebar-container"></div>

            <!-- Main Content -->
            <main class="admin-main-content">
                <!-- Page Header -->
                <div class="page-header">
                    <div>
                        <h1 class="page-title">‚öôÔ∏è Gesti√≥n de Usuarios</h1>
                        <p class="page-subtitle">Administra usuarios activos y visualiza sus registros</p>
                    </div>
                    <div class="page-actions">
                        <button class="admin-btn admin-btn-outline" onclick="loadUsuarios()">
                            üîÑ Actualizar
                        </button>
                        <button class="admin-btn admin-btn-primary" onclick="exportUsers()">
                            üìä Exportar
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-content">
                            <h3 class="stat-title">Total Usuarios</h3>
                            <p class="stat-value" id="totalUsersCount">0</p>
                            <p class="stat-change" id="totalUsersChange">En el sistema</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-content">
                            <h3 class="stat-title">Usuarios Activos</h3>
                            <p class="stat-value" id="activeUsersCount">0</p>
                            <p class="stat-change" id="activeUsersChange">Estado activo</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">‚è∏Ô∏è</div>
                        <div class="stat-content">
                            <h3 class="stat-title">Usuarios Inactivos</h3>
                            <p class="stat-value" id="inactiveUsersCount">0</p>
                            <p class="stat-change" id="inactiveUsersChange">Estado inactivo</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-content">
                            <h3 class="stat-title">Nuevos Hoy</h3>
                            <p class="stat-value" id="newUsersToday">0</p>
                            <p class="stat-change" id="newUsersTodayChange">Registros recientes</p>
                        </div>
                    </div>
                </div>                <!-- Filters and Actions -->
                <div class="admin-actions-bar">
                    <div class="admin-actions-left">
                        <select class="admin-btn admin-btn-secondary" id="statusFilter" onchange="filterUsers()">
                            <option value="">Todos los estados</option>
                            <option value="A">Activos</option>
                            <option value="I">Inactivos</option>
                            <option value="S">Suspendidos</option>
                        </select>
                        <select class="admin-btn admin-btn-secondary" id="roleFilter" onchange="filterUsers()">
                            <option value="">Todos los roles</option>
                            <option value="1">Usuario</option>
                            <option value="2">Biomonitor</option>
                            <option value="3">Administrador</option>
                            <option value="4">Super Admin</option>
                        </select>
                        <input type="text" 
                               class="admin-input" 
                               id="searchInput" 
                               placeholder="üîç Buscar por nombre o email..." 
                               onkeyup="filterUsers()"
                               style="width: 250px;">
                    </div>
                    <div class="admin-badge admin-badge-info">
                        <span id="userCount">0</span> usuarios totales
                    </div>
                </div>

                <!-- Users Table -->
                <div class="admin-table-container">
                    <table class="admin-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Registros</th>
                                <th>√öltima Actividad</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            <tr>
                                <td colspan="7" class="admin-loading">
                                    <div class="loading-spinner"></div>
                                    Cargando usuarios...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="admin-card" style="display: none; text-align: center; padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üë•</div>
                    <h3 style="margin: 0 0 0.5rem 0; color: var(--admin-text-primary);">No se encontraron usuarios</h3>
                    <p style="color: var(--admin-text-secondary); margin: 0;">Ajusta los filtros para ver m√°s resultados</p>    <!-- Scripts -->
    <script src="js/sidebar-loader.js"></script>
    <script src="js/admin-super-admin-clean.js"></script>
    <script>
        let userToken = localStorage.getItem('token');
        let allUsers = [];
        let filteredUsers = [];

        // Funci√≥n principal para cargar usuarios
        async function loadUsuarios() {
            try {
                const tbody = document.getElementById('user-table-body');
                const emptyState = document.getElementById('emptyState');
                
                // Mostrar loading
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="admin-loading">
                            <div class="loading-spinner"></div>
                            Cargando usuarios...
                        </td>
                    </tr>
                `;
                emptyState.style.display = 'none';

                if (!userToken) {
                    console.error('No token found in localStorage');
                    window.location.href = 'login.html';
                    return;
                }

                console.log('üîÑ Cargando usuarios desde API...');
                const response = await fetch('/Consultas/api/getusers', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${userToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const users = result.records || result || [];
                allUsers = users;
                filteredUsers = users;
                
                console.log(`‚úÖ ${users.length} usuarios cargados`);
                updateStats(users);
                displayUsers(users);

            } catch (error) {
                console.error('‚ùå Error loading users:', error);
                const tbody = document.getElementById('user-table-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--admin-danger); padding: 2rem;">
                            Error al cargar usuarios: ${error.message}
                            <br><button class="admin-btn admin-btn-outline admin-btn-sm" onclick="loadUsuarios()">Reintentar</button>
                        </td>
                    </tr>
                `;
                
                // Cargar datos de demostraci√≥n
                loadDemoData();
            }
        }

        // Funci√≥n para actualizar estad√≠sticas
        function updateStats(users) {
            const total = users.length;
            const active = users.filter(u => u.estado === 'A' || u.status === 'active').length;
            const inactive = users.filter(u => u.estado === 'I' || u.status === 'inactive').length;
            const today = new Date().toDateString();
            const newToday = users.filter(u => {
                if (u.fechaRegistro) {
                    return new Date(u.fechaRegistro).toDateString() === today;
                }
                return false;
            }).length;

            document.getElementById('totalUsersCount').textContent = total;
            document.getElementById('activeUsersCount').textContent = active;
            document.getElementById('inactiveUsersCount').textContent = inactive;
            document.getElementById('newUsersToday').textContent = newToday;
            document.getElementById('userCount').textContent = total;
        }

        // Funci√≥n para mostrar usuarios en la tabla
        function displayUsers(users) {
            const tbody = document.getElementById('user-table-body');
            const emptyState = document.getElementById('emptyState');

            if (users.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            tbody.innerHTML = users.map(user => `
                <tr id="user-${user.idUsuario || user.id}">
                    <td>
                        <div class="user-info">
                            <div class="admin-avatar" style="width: 32px; height: 32px; font-size: 0.875rem;">
                                ${user.Nombre ? user.Nombre.charAt(0).toUpperCase() : 'U'}
                            </div>
                            <div>
                                <div class="user-name">${user.Nombre || 'Sin nombre'} ${user.Apellidos || ''}</div>
                                <div class="user-id">ID: ${user.idUsuario || user.id}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.email || 'Sin email'}</td>
                    <td>
                        <span class="role-badge ${getRoleClass(user.rol)}">
                            ${getRoleText(user.rol)}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${getStatusClass(user.estado)}">
                            ${getStatusText(user.estado)}
                        </span>
                    </td>
                    <td>${user.totalRegistros || 0}</td>
                    <td>${formatDate(user.ultimaActividad || user.fechaRegistro)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="admin-btn admin-btn-sm admin-btn-outline" onclick="viewUser('${user.idUsuario || user.id}')">
                                üëÅÔ∏è Ver
                            </button>
                            <button class="admin-btn admin-btn-sm ${user.estado === 'A' ? 'admin-btn-danger' : 'admin-btn-success'}" 
                                    onclick="toggleUserStatus('${user.idUsuario || user.id}', '${user.estado}')">
                                ${user.estado === 'A' ? '‚è∏Ô∏è Desactivar' : '‚úÖ Activar'}
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Funciones de filtrado
        function filterUsers() {
            const statusFilter = document.getElementById('statusFilter').value;
            const roleFilter = document.getElementById('roleFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            filteredUsers = allUsers.filter(user => {
                const matchesStatus = !statusFilter || user.estado === statusFilter;
                const matchesRole = !roleFilter || user.rol == roleFilter;
                const matchesSearch = !searchInput || 
                    (user.Nombre && user.Nombre.toLowerCase().includes(searchInput)) ||
                    (user.Apellidos && user.Apellidos.toLowerCase().includes(searchInput)) ||
                    (user.email && user.email.toLowerCase().includes(searchInput));

                return matchesStatus && matchesRole && matchesSearch;
            });

            displayUsers(filteredUsers);
            document.getElementById('userCount').textContent = filteredUsers.length;
        }

        // Funciones auxiliares
        function getRoleText(role) {
            switch (parseInt(role)) {
                case 1: return 'Usuario';
                case 2: return 'Biomonitor';
                case 3: return 'Administrador';
                case 4: return 'Super Admin';
                default: return 'Sin rol';
            }
        }

        function getRoleClass(role) {
            switch (parseInt(role)) {
                case 1: return 'role-usuario';
                case 2: return 'role-biomonitor';
                case 3: return 'role-admin';
                case 4: return 'role-superadmin';
                default: return 'role-none';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'A': return 'Activo';
                case 'I': return 'Inactivo';
                case 'S': return 'Suspendido';
                default: return 'Desconocido';
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'A': return 'status-active';
                case 'I': return 'status-inactive';
                case 'S': return 'status-suspended';
                default: return 'status-unknown';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'Sin fecha';
            try {
                return new Date(dateString).toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                return 'Fecha inv√°lida';
            }
        }

        // Acciones de usuario
        async function viewUser(userId) {
            alert(`Ver detalles del usuario ${userId}\n\nFuncionalidad en desarrollo.`);
        }

        async function toggleUserStatus(userId, currentStatus) {
            const newStatus = currentStatus === 'A' ? 'I' : 'A';
            const action = newStatus === 'A' ? 'activar' : 'desactivar';
            
            if (!confirm(`¬øEst√°s seguro de que quieres ${action} este usuario?`)) {
                return;
            }

            try {
                console.log(`Cambiando estado del usuario ${userId} a ${newStatus}`);
                
                // Simular llamada API
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Actualizar en memoria
                const userIndex = allUsers.findIndex(u => (u.idUsuario || u.id) == userId);
                if (userIndex !== -1) {
                    allUsers[userIndex].estado = newStatus;
                    filterUsers(); // Refresh display
                }
                
                alert(`Usuario ${action} exitosamente`);
            } catch (error) {
                console.error('Error updating user status:', error);
                alert('Error al actualizar el estado del usuario');
            }
        }

        // Funci√≥n de exportaci√≥n
        function exportUsers() {
            alert('üìä Exportar Usuarios\n\nFuncionalidad de exportaci√≥n en desarrollo.\n\nPermitir√° exportar la lista de usuarios en formato:\n‚Ä¢ Excel (.xlsx)\n‚Ä¢ CSV\n‚Ä¢ PDF');
        }

        // Cargar datos de demostraci√≥n
        function loadDemoData() {
            console.log('üìã Cargando datos de demostraci√≥n...');
            const demoUsers = [
                {
                    idUsuario: 1,
                    Nombre: 'Juan',
                    Apellidos: 'P√©rez Garc√≠a',
                    email: 'juan.perez@email.com',
                    rol: 2,
                    estado: 'A',
                    totalRegistros: 15,
                    fechaRegistro: '2024-01-15',
                    ultimaActividad: '2024-06-10'
                },
                {
                    idUsuario: 2,
                    Nombre: 'Mar√≠a',
                    Apellidos: 'Gonz√°lez L√≥pez',
                    email: 'maria.gonzalez@email.com',
                    rol: 1,
                    estado: 'A',
                    totalRegistros: 8,
                    fechaRegistro: '2024-02-20',
                    ultimaActividad: '2024-06-09'
                },
                {
                    idUsuario: 3,
                    Nombre: 'Carlos',
                    Apellidos: 'Mart√≠nez Ruiz',
                    email: 'carlos.martinez@email.com',
                    rol: 3,
                    estado: 'I',
                    totalRegistros: 32,
                    fechaRegistro: '2023-12-10',
                    ultimaActividad: '2024-05-28'
                }
            ];
            
            allUsers = demoUsers;
            filteredUsers = demoUsers;
            updateStats(demoUsers);
            displayUsers(demoUsers);
        }

        // Cargar sidebar
        async function loadSidebar() {
            try {
                const response = await fetch('components/admin-sidebar.html');
                if (response.ok) {
                    const sidebarHtml = await response.text();
                    document.getElementById('sidebar-container').innerHTML = sidebarHtml;
                    
                    // Marcar el item activo
                    setTimeout(() => {
                        const menuItems = document.querySelectorAll('.sidebar-item');
                        menuItems.forEach(item => {
                            item.classList.remove('active');
                            if (item.getAttribute('data-page') === 'gestion-usuarios' || 
                                item.href && item.href.includes('AdmUpReguser.html')) {
                                item.classList.add('active');
                            }
                        });
                    }, 100);
                }
            } catch (error) {
                console.error('Error loading sidebar:', error);
            }
        }

        // Configurar toggle de sidebar
        function setupSidebarToggle() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.admin-sidebar') || document.querySelector('.sidebar');
            
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    sidebarToggle.classList.toggle('sidebar-open');
                });
            }
        }

        // Funci√≥n para cerrar sesi√≥n
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userData');
            window.location.href = 'login.html';
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ DOM cargado, inicializando gesti√≥n de usuarios...');
            
            loadSidebar().then(() => {
                setupSidebarToggle();
            });
            
            if (!userToken) {
                window.location.href = 'login.html';
                return;
            }

            loadUsuarios();

            // Actualizar informaci√≥n del usuario si est√° disponible
            const userData = localStorage.getItem('userData');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    if (user.name) {
                        document.getElementById('userName').textContent = user.name;
                        document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
                    }
                } catch (e) {
                    console.warn('Error parsing user data:', e);
                }
            }
        });
    </script>
</body>
</html>